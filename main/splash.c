#include "sdkconfig.h"
#include "ssd1306.h"
#include "ssd1306-priv.h"

#include <esp_random.h>

#define TAG                 "SSD1306"
#define SCREEN_SPLASH_FPS   10
#define SCREEN_SPLASH_TICKS pdMS_TO_TICKS(1000/SCREEN_SPLASH_FPS)

// https://mischianti.org/ssd1306-oled-display-draw-images-splash-and-animations-2/
const uint8_t splash_bmp[] = {
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

	0x00, 0x00, 0x00, 0xc0, 0xe0, 0xf8, 0x7c, 0x3c, 0x1c, 0x1c, 0x1c, 0x1c, 0x3c, 0x3c, 0xf8, 0xfc, 
	0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xf8, 0xfc, 0x9c, 0x1c, 0x3c, 0x38, 0x10, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0xf8, 0x78, 0x3c, 0x1c, 0x1e, 0x1e, 0x1e, 0x1e, 0x1c, 0x3c, 
	0x78, 0x30, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0xf0, 0x78, 0x38, 0x1c, 0x3c, 0x3c, 0x3c, 0x38, 
	0xf8, 0xf0, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xf9, 0xf9, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xf0, 0xf0, 0x78, 
	0x38, 0x38, 0x18, 0x18, 0x38, 0x38, 0x78, 0xf0, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 
	0xf8, 0xf8, 0xf0, 0xf0, 0x78, 0x3c, 0x3c, 0x3c, 0x78, 0xf8, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 

	0x00, 0x00, 0x00, 0x1f, 0x3f, 0xff, 0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xf0, 0xff, 0xff, 
	0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe1, 0xe3, 0xc3, 0xc7, 0xc7, 0xfe, 0xfe, 0xfc, 0x70, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0xff, 0xe0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0xc0, 0xc0, 0xe0, 
	0xc0, 0x80, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xff, 0xff, 0xe7, 0xc7, 0x87, 0x87, 0x87, 0x87, 0x87, 
	0xc7, 0xff, 0xf7, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xe3, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xf0, 0xc0, 
	0xc0, 0x80, 0x80, 0x80, 0x80, 0xc0, 0xf0, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
	0xff, 0xff, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 

	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 
	0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 
	0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x07, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 
	0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 

	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	// 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

void ssd1306_show_splash(ssd1306_t device)
{
	// TickType_t ticks = xTaskGetTickCount();

	// uint8_t buff[device->width];

	// ssd1306_auto_flush(device, false);
	// for( unsigned page = 0; page < device->pages; page++ ) {
	// 	esp_fill_random(raster_page_data(device, page), device->width);
	// }
	// ssd1306_auto_flush(device, true);

	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));
	// ssd1306_clear_b(device, NULL);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));

	// for( unsigned page = 0; page < device->pages; page++ ) {
	// 	for( unsigned bits = 0; bits < 8; bits++ ) {
	// 		memset(buff, (1<<(bits+1))-1, device->width);
	// 		ssd1306_fill_page(device, page, 0, device->width, buff, 0);

	// 		vTaskDelayUntil(&ticks, SCREEN_SPLASH_TICKS);
	// 	}
	// }
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(100));

	// for( int page = device->pages-1; page >= 0; page-- ) {
	// 	for( unsigned bits = 8; bits > 0; bits-- ) {
	// 		memset(buff, (1<<(bits-1))-1, device->width);
	// 		ssd1306_fill_page(device, page, 0, device->width, buff, 0);

	// 		vTaskDelayUntil(&ticks, SCREEN_SPLASH_TICKS);
	// 	}
	// }
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(100));

	// const unsigned slice = _countof(buff)/5;

	// memset(buff + 0*slice, 0xFF, slice);
	// memset(buff + 1*slice, 0xCC, slice);
	// memset(buff + 2*slice, 0xAA, slice);
	// memset(buff + 3*slice, 0x55, slice);

	// ssd1306_bounds_t bounds = {
	// 	0, 8,
	// 	4*slice, 8,
	// };
	// ssd1306_bitmap_b(device, buff, &bounds);

	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(2000));

	// for( bounds.x = -8; bounds.x < 2 * device->width; bounds.x++ ) {
	// 	ssd1306_bitmap_b(device, buff, &bounds);
	// 	vTaskDelayUntil(&ticks, SCREEN_SPLASH_TICKS);
	// 	ssd1306_clear_b(device, &bounds);
	// }

	// for( bounds.y = 8; bounds.y < device->height; bounds.y++ ) {
	// 	ssd1306_auto_flush(device, false);
	// 	ssd1306_clear_b(device, NULL);
	// 	ssd1306_bitmap_b(device, buff, &bounds);
	// 	ssd1306_auto_flush(device, true);

	// 	vTaskDelayUntil(&ticks, pdMS_TO_TICKS(200));
	// }

	// ssd1306_fill_page(device, 2, 0, device->width, buff, -5);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));
	// ssd1306_fill_page(device, 3, 0, device->width, buff, +3);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));

	// ssd1306_fill_page(device, 3, 0, device->width, buff, -3);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));
	// ssd1306_fill_page(device, 4, 0, device->width, buff, 5);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));

	// ssd1306_fill_page(device, 4, 0, device->width, buff, 3);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));
	// ssd1306_fill_page(device, 5, 0, device->width, buff, -5);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));

	// unsigned bmp_h = 8 * sizeof(splash_bmp) / device->width;
	// unsigned bmp_w = device->width;
	// int bmp_wi = bmp_w + 4;
	// int bmp_hi = device->height + 8;

	// LOG_I("Splash size = %u / %ux%u", sizeof(splash_bmp), bmp_w, bmp_h);

	// ssd1306_auto_flush(device, false);
	// ssd1306_clear(device, NULL);
	// ssd1306_bitmap(device, 0, 8, splash_bmp, device->width, bmp_h);
	// ssd1306_auto_flush(device, true);
 	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(2000));

	// ssd1306_auto_flush(device, false);
	// ssd1306_clear(device, NULL);
	// ssd1306_bitmap(device, 0, 9, splash_bmp, device->width, bmp_h);
	// ssd1306_auto_flush(device, true);
	// vTaskDelayUntil(&ticks, pdMS_TO_TICKS(2000));
 
	// for( int x = -bmp_wi; x < bmp_wi; x++ ) {
	// 	ssd1306_auto_flush(device, false);
	// 	ssd1306_clear(device, NULL);
	// 	ssd1306_bitmap(device, x, 0, splash_bmp, device->width, bmp_h);
	// 	ssd1306_auto_flush(device, true);

	// 	vTaskDelayUntil(&ticks, SCREEN_SPLASH_TICKS);
	// }

	// for( int y = -bmp_hi; y < bmp_hi; y += 8 ) {
	// 	ssd1306_auto_flush(device, false);
	// 	ssd1306_clear(device, NULL);
	// 	ssd1306_bitmap(device, 0, y, splash_bmp, device->width, bmp_h);
	// 	ssd1306_auto_flush(device, true);

	// 	vTaskDelayUntil(&ticks, pdMS_TO_TICKS(1000));
	// }
}

